{% extends 'base.html' %}
{% load static %}
{% load photo_crop_tags %}

{% block title %}Crop US Passport Photo{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-4 max-w-4xl bg-white bg-opacity-50 rounded-lg shadow-sm border border-border mt-8">
    <!-- 标题和说明 -->
    <div class="text-center mb-6 bg-white bg-opacity-50 rounded-lg shadow-sm p-4">
        <h1 class="text-2xl font-bold text-text-primary">Adjust Your Photo</h1>
        <p class="text-text-secondary mt-2">Move and scale your photo to fit the frame</p>
    </div>

    <!-- 图片编辑区域 -->
    <div class="bg-white bg-opacity-50 rounded-lg shadow-sm mb-6">
        <div class="p-4">
            <div class="relative w-full bg-gray-900 overflow-hidden" style="aspect-ratio: 4/3; max-width: min(800px, 100%); margin: 0 auto;">
                <!-- 照片（保持在底层） -->
                <img src="{% get_media_url file %}" 
                     alt="Upload photo" 
                     class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 cursor-grab z-0"
                     id="cropImage"
                     style="transform-origin: center; max-width: 100%; max-height: 100%; object-fit: contain;">

                <!-- 上方遮罩 -->
                <div class="absolute top-0 left-0 right-0 bg-black bg-opacity-50 z-20"
                     style="height: calc(50% - 1in);"></div>
                <!-- 下方遮罩 -->
                <div class="absolute bottom-0 left-0 right-0 bg-black bg-opacity-50 z-20"
                     style="height: calc(50% - 1in);"></div>
                <!-- 左侧遮罩 -->
                <div class="absolute top-1/2 left-0 bg-black bg-opacity-50 z-20"
                     style="height: 2in; width: calc(50% - 1in); transform: translateY(-50%);"></div>
                <!-- 右侧遮罩 -->
                <div class="absolute top-1/2 right-0 bg-black bg-opacity-50 z-20"
                     style="height: 2in; width: calc(50% - 1in); transform: translateY(-50%);"></div>

                <!-- 裁剪框和辅助线（最上层） -->
                <div class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 border-2 border-secondary bg-transparent z-30"
                     style="width: 2in; height: 2in; pointer-events: none;">
                    <!-- 垂直中心线 -->
                    <div class="absolute left-1/2 top-0 bottom-0 border-l border-secondary opacity-50" 
                         style="transform: translateX(-50%); pointer-events: none;"></div>
                    
                    <!-- 眼睛位置范围（56%-69%，从底部算起，蓝色） -->
                    <div class="absolute left-0 right-0 border-b-2 border-blue-500 opacity-50" 
                         style="bottom: 1.38in; pointer-events: none;"></div>
                    <div class="absolute left-0 right-0 border-b-2 border-blue-500 opacity-50" 
                         style="bottom: 1.12in; pointer-events: none;"></div>
                    
                    <!-- 添加文字说明 -->
                    <div class="absolute right-full mr-2 text-xs text-blue-500" 
                         style="bottom: 1.25in;">Eye level</div>
                    
                    <!-- 添加详细说明 -->
                    <div class="absolute left-full ml-4 text-xs text-white space-y-2">
                        <div>Photo size: 2"×2"</div>
                        <div>Eye height: 1.12"-1.38" from bottom</div>
                        <div>Head height should be</div>
                        <div>50%-69% of photo height</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 操作按钮 -->
    <div class="flex justify-end space-x-4 p-4">
        <button onclick="window.history.back()" 
                class="px-6 py-2 bg-white hover:bg-gray-100 text-text-primary rounded-lg border border-border">
            Back
        </button>
        <button id="nextButton"
                class="px-6 py-2 bg-secondary hover:bg-background-dark text-white rounded-lg">
            Next
        </button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const image = document.getElementById('cropImage');
    const container = document.querySelector('.relative');  // 画布容器
    let isDragging = false;
    let lastX = 0;
    let lastY = 0;
    let translateX = 0;
    let translateY = 0;
    let scale = 1;
    let initialDistance = 0;  // 用于双指缩放

    // 初始化图片大小和位置
    function initTransform() {
        // 设置初始缩放为1，让CSS控制初始大小
        scale = 1;
        translateX = 0;
        translateY = 0;
        updateImageTransform();
    }

    // 页面加载时初始化
    initTransform();

    // 触摸事件处理
    image.addEventListener('touchstart', function(e) {
        e.preventDefault();
        if (e.touches.length === 1) {
            // 单指拖动
            isDragging = true;
            lastX = e.touches[0].clientX;
            lastY = e.touches[0].clientY;
        } else if (e.touches.length === 2) {
            // 双指缩放
            isDragging = false;
            initialDistance = getTouchDistance(e.touches);
        }
    });

    image.addEventListener('touchmove', function(e) {
        e.preventDefault();
        if (e.touches.length === 1 && isDragging) {
            // 单指拖动
            const deltaX = e.touches[0].clientX - lastX;
            const deltaY = e.touches[0].clientY - lastY;
            
            translateX += deltaX;
            translateY += deltaY;
            
            lastX = e.touches[0].clientX;
            lastY = e.touches[0].clientY;
        } else if (e.touches.length === 2) {
            // 双指缩放
            const currentDistance = getTouchDistance(e.touches);
            const delta = currentDistance / initialDistance;
            
            // 限制缩放范围
            scale = Math.min(Math.max(0.5, delta), 3);
            initialDistance = currentDistance;
        }
        updateImageTransform();
    });

    image.addEventListener('touchend', function(e) {
        if (e.touches.length === 0) {
            isDragging = false;
        }
    });

    // 计算两个触摸点之间的距离
    function getTouchDistance(touches) {
        const dx = touches[0].clientX - touches[1].clientX;
        const dy = touches[0].clientY - touches[1].clientY;
        return Math.sqrt(dx * dx + dy * dy);
    }

    // 鼠标拖拽
    image.addEventListener('mousedown', function(e) {
        isDragging = true;
        lastX = e.clientX;
        lastY = e.clientY;
        image.style.cursor = 'grabbing';
        e.preventDefault();
        
        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);
    });

    function onMouseMove(e) {
        if (!isDragging) return;
        
        const deltaX = e.clientX - lastX;
        const deltaY = e.clientY - lastY;
        
        translateX += deltaX;
        translateY += deltaY;
        
        lastX = e.clientX;
        lastY = e.clientY;
        
        updateImageTransform();
    }

    function onMouseUp() {
        isDragging = false;
        image.style.cursor = 'grab';
        // 移除事件监听
        document.removeEventListener('mousemove', onMouseMove);
        document.removeEventListener('mouseup', onMouseUp);
    }

    // 滚轮缩放
    document.addEventListener('wheel', function(e) {
        if (!e.target.closest('.relative')) return;
        
        e.preventDefault();
        const delta = e.deltaY > 0 ? 0.9 : 1.1;
        scale *= delta;
        
        // 限制缩放范围
        scale = Math.min(Math.max(0.5, scale), 3);
        
        updateImageTransform();
    }, { passive: false });

    function updateImageTransform() {
        image.style.transform = `translate(calc(-50% + ${translateX}px), calc(-50% + ${translateY}px)) scale(${scale})`;
    }
});
</script>
{% endblock %}
